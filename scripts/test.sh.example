#!/bin/bash

# ğŸ§ª Script de Tests Personalizado
# Copia este archivo como scripts/test.sh y personalÃ­zalo para tu proyecto

# Activa el modo estricto: cualquier error hace que el script se detenga
set -e

# ğŸ¨ Colores para el output en consola
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # Sin color

echo -e "${BLUE}ğŸ§ª Ejecutando tests personalizados...${NC}"

# ğŸ“‹ AquÃ­ puedes aÃ±adir tus propios tests
# Ejemplos de diferentes tipos de tests:

# 1. Tests de linting
echo -e "${YELLOW}ğŸ” Ejecutando linting...${NC}"
if command -v eslint &> /dev/null; then
    if npx eslint . --ext .js,.jsx,.ts,.tsx; then
        echo -e "${GREEN}âœ… Linting pasado${NC}"
    else
        echo -e "${RED}âŒ Linting fallÃ³${NC}"
        exit 1
    fi
fi

# 2. Tests de formato de cÃ³digo
echo -e "${YELLOW}ğŸ¨ Verificando formato de cÃ³digo...${NC}"
if command -v prettier &> /dev/null; then
    if npx prettier --check .; then
        echo -e "${GREEN}âœ… Formato de cÃ³digo correcto${NC}"
    else
        echo -e "${RED}âŒ Formato de cÃ³digo incorrecto${NC}"
        exit 1
    fi
fi

# 3. Tests de seguridad
echo -e "${YELLOW}ğŸ”’ Verificando vulnerabilidades...${NC}"
if command -v npm &> /dev/null; then
    if npm audit --audit-level moderate; then
        echo -e "${GREEN}âœ… Sin vulnerabilidades crÃ­ticas${NC}"
    else
        echo -e "${RED}âŒ Vulnerabilidades detectadas${NC}"
        exit 1
    fi
fi

# 4. Tests de build
echo -e "${YELLOW}ğŸ—ï¸  Verificando build...${NC}"
if [ -f "package.json" ]; then
    if npm run build; then
        echo -e "${GREEN}âœ… Build exitoso${NC}"
    else
        echo -e "${RED}âŒ Build fallÃ³${NC}"
        exit 1
    fi
fi

# 5. Tests unitarios (si no estÃ¡n en package.json)
echo -e "${YELLOW}ğŸ§© Ejecutando tests unitarios...${NC}"
if [ -d "tests" ] || [ -d "__tests__" ]; then
    if npm test; then
        echo -e "${GREEN}âœ… Tests unitarios pasaron${NC}"
    else
        echo -e "${RED}âŒ Tests unitarios fallaron${NC}"
        exit 1
    fi
fi

# 6. Tests de integraciÃ³n
echo -e "${YELLOW}ğŸ”— Ejecutando tests de integraciÃ³n...${NC}"
if [ -f "scripts/test-integration.sh" ]; then
    if bash scripts/test-integration.sh; then
        echo -e "${GREEN}âœ… Tests de integraciÃ³n pasaron${NC}"
    else
        echo -e "${RED}âŒ Tests de integraciÃ³n fallaron${NC}"
        exit 1
    fi
fi

# 7. Tests de base de datos
echo -e "${YELLOW}ğŸ—„ï¸  Verificando conexiÃ³n a base de datos...${NC}"
# Ejemplo para PostgreSQL
if command -v psql &> /dev/null; then
    if psql -h localhost -U postgres -d test_db -c "SELECT 1;" &> /dev/null; then
        echo -e "${GREEN}âœ… ConexiÃ³n a BD exitosa${NC}"
    else
        echo -e "${YELLOW}âš ï¸  No se pudo conectar a BD (continuando)${NC}"
    fi
fi

# 7.1. Tests de Python (si aplica)
echo -e "${YELLOW}ğŸ Ejecutando tests de Python...${NC}"
if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
    # Intentar con python3 primero, luego con python
    if command -v python3 &> /dev/null; then
        if python3 -m pytest; then
            echo -e "${GREEN}âœ… Tests de Python (python3) pasaron${NC}"
        else
            echo -e "${RED}âŒ Tests de Python (python3) fallaron${NC}"
            exit 1
        fi
    elif command -v python &> /dev/null; then
        if python -m pytest; then
            echo -e "${GREEN}âœ… Tests de Python (python) pasaron${NC}"
        else
            echo -e "${RED}âŒ Tests de Python (python) fallaron${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}âš ï¸  No se encontrÃ³ python3 ni python${NC}"
    fi
fi

# 8. Tests de Docker (si aplica)
echo -e "${YELLOW}ğŸ³ Verificando imÃ¡genes Docker...${NC}"
if [ -f "Dockerfile" ]; then
    if docker build -t test-image .; then
        echo -e "${GREEN}âœ… Build de Docker exitoso${NC}"
        # Limpiar imagen de test
        docker rmi test-image &> /dev/null || true
    else
        echo -e "${RED}âŒ Build de Docker fallÃ³${NC}"
        exit 1
    fi
fi

# 9. Tests de configuraciÃ³n
echo -e "${YELLOW}âš™ï¸  Verificando configuraciÃ³n...${NC}"
if [ -f ".env.example" ] && [ ! -f ".env" ]; then
    echo -e "${YELLOW}âš ï¸  Archivo .env no encontrado, copiando desde .env.example${NC}"
    cp .env.example .env
fi

# 10. Tests de dependencias
echo -e "${YELLOW}ğŸ“¦ Verificando dependencias...${NC}"
if [ -f "package.json" ]; then
    if npm ci --only=production; then
        echo -e "${GREEN}âœ… Dependencias verificadas${NC}"
    else
        echo -e "${RED}âŒ Error con dependencias${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}ğŸ‰ Â¡Todos los tests pasaron exitosamente!${NC}" 