# @see https://github.com/ohmyzsh/ohmyzsh/wiki/Cheatsheet
# Expand alias -> C-x a

# =============================================================================
# Aliases personalizados para el sistema
# =============================================================================

# ------------------------------------
# Unix - Comandos b√°sicos del sistema
# ------------------------------------
alias ll="ls -alF"      # Lista detallada con / para directorios
alias la="ls -A"        # Lista casi todos los archivos, excluyendo . y ..
alias l="ls -CF"        # Lista compacta
alias ln="ln -v"        # Crear enlaces simb√≥licos verboso
alias mkdir="mkdir -p"  # Crear directorios con padres si es necesario
alias e="$EDITOR"       # Abrir editor predeterminado
alias v="$VISUAL"       # Abrir editor visual
alias ..="cd .."        # Subir un nivel
alias ...="cd ../.."    # Subir dos niveles

# ------------------------------------
# Informaci√≥n y gesti√≥n del sistema
# ------------------------------------
alias sysinfo="~/dotfiles/scripts/system_info.sh"  # Mostrar informaci√≥n del sistema
alias path='echo $PATH | tr -s ":" "\n"'           # Mostrar PATH formateado
alias htop="htop"                                  # Monitor de sistema
alias ping="ping -c 5"                             # Ping limitado a 5 paquetes
alias df="df -h"                                   # Mostrar uso de disco en formato legible
alias free="free -h"                               # Mostrar uso de memoria en formato legible

# Funci√≥n para manejar Apache y MySQL/MariaDB
restart_apache() {
  if command -v apache2 >/dev/null 2>&1; then
    sudo service apache2 restart
    sudo service mysql restart
    sudo service apache2 status
    sudo service mysql status
  fi
}

# =============================================================================
# Actualizaciones del sistema - Funci√≥n ups() con formato mejorado
# =============================================================================

# üé® Variables de colores para el output
_ups_green='\033[0;32m'
_ups_yellow='\033[1;33m'
_ups_red='\033[0;31m'
_ups_blue='\033[0;34m'
_ups_cyan='\033[0;36m'
_ups_magenta='\033[0;35m'
_ups_bold='\033[1m'
_ups_nc='\033[0m' # Sin color

# Funciones auxiliares para formateo visual
_ups_section() {
  echo -e "\n${_ups_cyan}${_ups_bold}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${_ups_nc}"
  echo -e "${_ups_cyan}${_ups_bold}$1${_ups_nc}"
  echo -e "${_ups_cyan}${_ups_bold}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${_ups_nc}\n"
}

_ups_success() {
  echo -e "${_ups_green}‚úÖ $1${_ups_nc}"
}

_ups_error() {
  echo -e "${_ups_red}‚ùå $1${_ups_nc}"
}

_ups_info() {
  echo -e "${_ups_blue}‚ÑπÔ∏è  $1${_ups_nc}"
}

_ups_warning() {
  echo -e "${_ups_yellow}‚ö†Ô∏è  $1${_ups_nc}"
}

_ups_progress() {
  echo -e "${_ups_yellow}‚è≥ $1${_ups_nc}"
}

# Funci√≥n principal de actualizaci√≥n del sistema
ups() {
  local start_time=$(date +%s)
  local errors=0
  local error_messages=()
  
  # Encabezado inicial
  echo -e "\n${_ups_magenta}${_ups_bold}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${_ups_nc}"
  echo -e "${_ups_magenta}${_ups_bold}‚ïë${_ups_nc}  ${_ups_bold}üöÄ ACTUALIZACI√ìN DEL SISTEMA${_ups_nc}                                    ${_ups_magenta}${_ups_bold}‚ïë${_ups_nc}"
  echo -e "${_ups_magenta}${_ups_bold}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${_ups_nc}\n"
  
  # Detectar entorno WSL
  if [[ -f /proc/version ]] && grep -qi microsoft /proc/version; then
    _ups_info "Entorno detectado: Ubuntu WSL"
  fi
  
  # üîê Secci√≥n: Autenticaci√≥n sudo
  _ups_section "üîê Autenticaci√≥n sudo"
  _ups_progress "Verificando credenciales sudo..."
  if sudo -v; then
    _ups_success "Credenciales sudo verificadas"
  else
    _ups_error "Error al verificar credenciales sudo"
    ((errors++))
    error_messages+=("Error en autenticaci√≥n sudo")
  fi
  
  # üì¶ Secci√≥n: Actualizaci√≥n de paquetes apt
  _ups_section "üì¶ Actualizaci√≥n de paquetes APT"
  
  # apt-get update
  _ups_progress "Actualizando lista de paquetes (apt-get update)..."
  local update_start=$(date +%s)
  if sudo apt-get update -y 2>&1 | tee /tmp/ups_apt_update.log; then
    local update_time=$(($(date +%s) - update_start))
    _ups_success "Lista de paquetes actualizada (${update_time}s)"
  else
    _ups_error "Error al actualizar lista de paquetes"
    ((errors++))
    error_messages+=("Error en apt update")
  fi
  
  # apt-get upgrade
  _ups_progress "Actualizando paquetes instalados (apt-get upgrade)..."
  local upgrade_start=$(date +%s)
  if sudo apt-get upgrade -y 2>&1 | tee /tmp/ups_apt_upgrade.log; then
    local upgrade_time=$(($(date +%s) - upgrade_start))
    _ups_success "Paquetes actualizados (${upgrade_time}s)"
    
    # Intentar extraer estad√≠sticas del log
    local upgraded_line=$(grep -oP '\d+ upgraded' /tmp/ups_apt_upgrade.log 2>/dev/null | head -1)
    if [ -n "$upgraded_line" ]; then
      _ups_info "Paquetes procesados: $upgraded_line"
    fi
  else
    _ups_error "Error al actualizar paquetes"
    ((errors++))
    error_messages+=("Error en apt upgrade")
  fi
  
  # apt-get autoremove
  _ups_section "üßπ Limpieza de paquetes"
  _ups_progress "Eliminando paquetes no utilizados (apt-get autoremove)..."
  local autoremove_start=$(date +%s)
  if sudo apt-get autoremove -y 2>&1 | tee /tmp/ups_apt_autoremove.log; then
    local autoremove_time=$(($(date +%s) - autoremove_start))
    _ups_success "Paquetes no utilizados eliminados (${autoremove_time}s)"
    
    # Intentar extraer informaci√≥n de espacio liberado
    local removed_line=$(grep -oP '\d+ removed' /tmp/ups_apt_autoremove.log 2>/dev/null | head -1)
    if [ -n "$removed_line" ]; then
      _ups_info "Paquetes eliminados: $removed_line"
    fi
  else
    _ups_warning "No se pudieron eliminar algunos paquetes (puede ser normal)"
  fi
  
  # üìö Secci√≥n: Actualizaci√≥n npm
  _ups_section "üìö Actualizaci√≥n de paquetes NPM"
  if command -v npm >/dev/null 2>&1; then
    _ups_progress "Actualizando paquete global: codex..."
    local npm_start=$(date +%s)
    if npm update -g codex 2>&1 | tee /tmp/ups_npm.log; then
      local npm_time=$(($(date +%s) - npm_start))
      _ups_success "Paquete npm 'codex' actualizado (${npm_time}s)"
    else
      _ups_warning "No se pudo actualizar el paquete npm 'codex' (puede no estar instalado)"
    fi
  else
    _ups_info "npm no est√° instalado, omitiendo actualizaci√≥n de paquetes npm"
  fi
  
  # ‚ö° Secci√≥n: Actualizaci√≥n Oh My Zsh
  _ups_section "‚ö° Actualizaci√≥n de Oh My Zsh"
  if command -v omz >/dev/null 2>&1 || [ -d "$ZSH" ]; then
    _ups_progress "Actualizando Oh My Zsh..."
    local omz_start=$(date +%s)
    if omz update 2>&1 | tee /tmp/ups_omz.log; then
      local omz_time=$(($(date +%s) - omz_start))
      _ups_success "Oh My Zsh actualizado (${omz_time}s)"
    else
      _ups_warning "Error al actualizar Oh My Zsh (continuando...)"
    fi
    
    _ups_progress "Actualizando customizaciones de Oh My Zsh..."
    if command -v upgrade_oh_my_zsh_custom >/dev/null 2>&1; then
      if upgrade_oh_my_zsh_custom 2>&1 | tee /tmp/ups_omz_custom.log; then
        _ups_success "Customizaciones de Oh My Zsh actualizadas"
      else
        _ups_warning "Error al actualizar customizaciones (puede ser normal)"
      fi
    else
      _ups_info "Funci√≥n upgrade_oh_my_zsh_custom no disponible"
    fi
  else
    _ups_info "Oh My Zsh no est√° instalado, omitiendo actualizaci√≥n"
  fi
  
  # üîÑ Secci√≥n: Reinicio de servicios
  _ups_section "üîÑ Reinicio de servicios"
  if command -v apache2 >/dev/null 2>&1; then
    _ups_progress "Reiniciando servicios Apache y MySQL..."
    local services_start=$(date +%s)
    if restart_apache 2>&1 | tee /tmp/ups_services.log; then
      local services_time=$(($(date +%s) - services_start))
      _ups_success "Servicios reiniciados correctamente (${services_time}s)"
    else
      _ups_warning "Algunos servicios no se pudieron reiniciar"
    fi
  else
    _ups_info "Apache2 no est√° instalado, omitiendo reinicio de servicios"
  fi
  
  # Resumen final
  local end_time=$(date +%s)
  local total_time=$(($end_time - start_time))
  local minutes=$((total_time / 60))
  local seconds=$((total_time % 60))
  
  echo -e "\n${_ups_magenta}${_ups_bold}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${_ups_nc}"
  echo -e "${_ups_magenta}${_ups_bold}‚ïë${_ups_nc}  ${_ups_bold}üìä RESUMEN DE ACTUALIZACI√ìN${_ups_nc}                                    ${_ups_magenta}${_ups_bold}‚ïë${_ups_nc}"
  echo -e "${_ups_magenta}${_ups_bold}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${_ups_nc}\n"
  
  echo -e "${_ups_blue}‚è±Ô∏è  Tiempo total de ejecuci√≥n: ${_ups_bold}${minutes}m ${seconds}s${_ups_nc}"
  
  if [ $errors -eq 0 ]; then
    echo -e "${_ups_green}${_ups_bold}‚úÖ Proceso completado sin errores${_ups_nc}\n"
  else
    echo -e "${_ups_red}${_ups_bold}‚ö†Ô∏è  Se encontraron ${errors} error(es) durante el proceso${_ups_nc}"
    for msg in "${error_messages[@]}"; do
      echo -e "${_ups_red}   ‚Ä¢ $msg${_ups_nc}"
    done
    echo ""
  fi
  
  # Limpiar archivos temporales
  rm -f /tmp/ups_*.log 2>/dev/null
  
  return $errors
}
alias apachestart="sudo service apache2 restart && sudo service mariadb restart"

# Gesti√≥n de logs
alias lc="sudo truncate -s 0 /var/log/apache2/error.log"  # Limpiar log de errores de Apache

# Seguridad y archivos
alias ffl='find . -mtime -1 -printf "%p\t%TY-%Tm-%Td %TH:%TM\t%u\t%g\t%m\n" | column -t | less'
alias files_user="find . -user www-data"
alias lusers="cut -d: -f1 /etc/passwd | sort"

# =============================================================================
# Git - Control de versiones
# =============================================================================

# ------------------------------------
# Comandos de Git que requieren shell (no se pueden mover a gitconfig)
# ------------------------------------
# Actualizar repositorio con limpieza de ramas
alias gitups="~/dotfiles/scripts/git_clean_branches.sh && gbinfo"

# ------------------------------------
# Funciones de Git (no se pueden mover a gitconfig)
# ------------------------------------
# Funci√≥n para add, commit y push r√°pido
gsave() {
  if [ $# -eq 0 ]; then
    git add -A && git commit -m "chore: quick save" --no-template && git push
  elif [ $# -eq 1 ]; then
    git add -A && git commit -m "chore: $1" --no-template && git push
  else
    echo "Uso: gsave [descripci√≥n opcional]"
  fi
}

# Funci√≥n para commits con formato convencional
gcommit() {
  if [ $# -eq 2 ]; then
    # gcommit <tipo> <descripci√≥n>
    git commit -m "$1: $2" --no-template
  elif [ $# -eq 3 ]; then
    # gcommit <tipo> <scope> <descripci√≥n>
    git commit -m "$1($2): $3" --no-template
  else
    echo "Uso: gcommit <tipo> <descripci√≥n>"
    echo "      gcommit <tipo> <scope> <descripci√≥n>"
    echo "Ejemplo: gcommit feat 'nueva funcionalidad'"
    echo "         gcommit fix api 'corregir error de autenticaci√≥n'"
  fi
}

# =============================================================================
# Herramientas y aplicaciones
# =============================================================================

# ------------------------------------
# IDEs y editores
# ------------------------------------
alias code.="code ."  # Abrir VSCode en directorio actual
alias vs="code"       # Atajo para VSCode

# Cursor CLI
alias cursor.="cursor-agent ."  # Abrir Cursor en directorio actual
alias cur="cursor-agent"        # Atajo para Cursor CLI
alias cura="cursor-agent --help" # Ayuda de Cursor CLI

# ------------------------------------
# Docker
# ------------------------------------
alias dps="docker ps"                                # Listar contenedores
alias di="docker images"                             # Listar im√°genes
alias drm="docker rm $(docker ps -a -q)"             # Eliminar contenedores parados
alias dri="docker rmi $(docker images -q)"           # Eliminar im√°genes sin usar
alias dcompose="docker-compose"                      # Atajo para docker-compose

# ------------------------------------
# Espec√≠ficos de proyectos
# ------------------------------------
alias cx="codex"  # Codex

# Bases de datos
alias create_goodreads_db='mysql -e "DROP DATABASE IF EXISTS goodreads; CREATE DATABASE goodreads; USE goodreads;" && mysql goodreads < ~/proyectos/goodreads/db/structure.sql'

# =============================================================================
# Inclusi√≥n de aliases locales (si existen)
# =============================================================================
if [[ -f ~/dotfiles-local/aliases.local ]]; then 
  source ~/dotfiles-local/aliases.local
fi